// Copyright (C) 2014 Erik Ringsmuth - MIT license

define(["require","config","ractive","rv!./xhrPanelTemplate","components/apiSequence/sequence","components/util/utilities","bower_components/URIjs/src/URI","vkbeautify","ace/ace","jquery","ractive-transitions-slide"],function(e){var t=e("config"),n=e("ractive"),r=e("rv!./xhrPanelTemplate"),i=e("components/apiSequence/sequence"),s=e("components/util/utilities"),o=e("bower_components/URIjs/src/URI"),u=e("vkbeautify"),a=e("ace/ace"),f=e("jquery");e("ractive-transitions-slide");var l=n.extend({template:r,el:"#api-sequence-placeholder",append:!0,data:{name:"XHR",method:"GET",url:"http://www.suri.io/",body:"",corsEnabled:!1,isPublic:!0,callCount:0,starCount:0,forkCount:0,owner:t.session.userId,starred:!1,signedIn:t.session.signedIn,responseBody:"",showOptions:!1,saveButtonClass:"default",sendButtonClass:"default",sendButtonDisabled:!1,showMoreButton:!1,fullScreen:!1,formatNumber:function(e){return e.toLocaleString()},formatDate:function(e){var t=new Date(e);return t.getFullYear()+"-"+t.getMonth()+"-"+t.getDay()+" "+t.getHours()+":"+t.getMinutes()}},init:function(){this.set("panelId",s.guid()),this.data.hasOwnProperty("headers")||this.set("headers",[]),this.data.hasOwnProperty("queryParameters")||this.set("queryParameters",[]),this.data.hasOwnProperty("tags")||this.set("tags",[]),this.data.hasOwnProperty("stars")||this.set("stars",[]),this.data.hasOwnProperty("forks")||this.set("forks",[]),this.set("isOwner",!this.get("id")||t.session.userId===this.get("owner")),this.get("stars").indexOf(t.session.userId)!==-1&&this.set("starred",!0);var e="";i.add(this);var n=a.edit(this.nodes.requestBody);n.getSession().setMode("ace/mode/json"),n.setTheme("ace/theme/chrome"),n.setOption("minLines",4),n.setOption("maxLines",1e4),n.setAutoScrollEditorIntoView(!0),n.renderer.setShowGutter(!1),n.renderer.setPadding(7),n.renderer.setScrollMargin(5,5),n.setShowPrintMargin(!1),n.getSession().setTabSize(2),n.getSession().setUseWrapMode(!0),n.setValue(this.get("body"),-1),n.on("change",function(e){this.set("body",n.getValue())}.bind(this));var r=a.edit(this.nodes.responseHeaders);r.setReadOnly(!0),r.setTheme("ace/theme/chrome"),r.setOption("minLines",0),r.setOption("maxLines",1e4),r.renderer.setShowGutter(!1),r.renderer.setPadding(7),r.renderer.setScrollMargin(5,5),r.setShowPrintMargin(!1),r.setHighlightGutterLine(!1),r.getSession().setUseWrapMode(!0);var c=a.edit(this.nodes.responseBody);c.setReadOnly(!0),c.setTheme("ace/theme/chrome"),c.setOption("minLines",0),c.setOption("maxLines",1e4),c.renderer.setShowGutter(!1),c.renderer.setPadding(7),c.renderer.setScrollMargin(5,5),c.setShowPrintMargin(!1),c.getSession().setTabSize(2),c.getSession().setUseWrapMode(!0),this.on({teardown:function(t){this.detach(),i.remove(this),t&&t.original&&t.original.stopPropagation&&t.original.stopPropagation()},scrollToPanel:function(){f("html,body").animate({scrollTop:document.getElementById(this.get("panelId")).offsetTop+f("#api-sequence").offset().top-15},200,"easeOutQuint")},setupTooltips:function(){f(".bs-tooltip").tooltip()},toggleOptions:function(){this.set("showOptions",!this.get("showOptions")),this.fire("setupTooltips")},toggleFullscreen:function(){this.set("fullScreen",!this.get("fullScreen"))},star:function(){this.get("starred")?f.ajax("/xhr/"+this.get("id")+"/stars/"+t.session.userId,{method:"DELETE"}).done(function(){this.data.stars.splice(this.data.stars.indexOf(t.session.userId),1),this.set("starCount",this.get("starCount")-1),this.set("starred",!1)}.bind(this)):f.ajax("/xhr/"+this.get("id")+"/stars",{method:"POST",data:t.session.userId}).done(function(){this.data.stars.push(t.session.userId),this.set("starCount",this.get("starCount")+1),this.set("starred",!0)}.bind(this))},save:function(){this.set("saveButtonClass","default");if(!this.get("signedIn"))return;this.get("id")?f.ajax("/xhr/"+this.get("id"),{type:"PUT",contentType:"application/json",data:this.toJSON()}).done(function(){this.set("saveButtonClass","success")}.bind(this)).fail(function(){this.set("saveButtonClass","danger")}.bind(this)):f.ajax("/xhr",{type:"POST",contentType:"application/json",data:this.toJSON()}).done(function(e){this.set("saveButtonClass","success"),this.set("id",e._id)}.bind(this)).fail(function(){this.set("saveButtonClass","danger")}.bind(this))},"delete":function(){this.get("id")?f.ajax("/xhr/"+this.get("id"),{type:"DELETE"}).done(function(){this.teardown()}.bind(this)):this.teardown()},fork:function(){var e=new l({data:JSON.parse(this.toJSON())});e.set({id:null,isOwner:!0,owner:t.session.userId,callCount:0,starCount:0,forkCount:0,forks:[],forkedFrom:this.get("id")}),e.fire("save"),this.data.forks.push("")},addTagOnEnter:function(e){if(e.original.keyCode===13){var t=e.node.value.replace(/\s/g,"").toLowerCase();this.get("tags").indexOf(t)===-1&&(this.get("tags").push(t),e.node.value="")}},deleteTag:function(e,t){this.get("tags").splice(this.get("tags").indexOf(t),1),e.original.preventDefault()},addBlankHeader:function(){this.get("headers").push({header:"",options:[],selected:"",required:!1})},removeHeader:function(e,t){this.get("headers").splice(this.get("headers").indexOf(t),1)},sendOnEnter:function(t){t.original.keyCode===13&&this.fire("send")},send:function(){this.set("sendButtonClass","default"),this.set("sendButtonDisabled",!0),this.set("callCount",this.get("callCount")+1);var t=this.get("headers"),n={};t.forEach(function(e){n[e.header]=e.selected});var r=this.get("url");r.indexOf("://")===-1&&(r="http://"+r);var i=new o(r),s=(new o(window.location.href)).host();!this.get("corsEnabled")&&i.host()!==s&&(n["api-host"]=i.protocol()+"://"+i.authority(),i.authority(s),i.protocol(window.location.protocol),n["api-id"]=this.get("id")),f.ajax({type:this.get("method"),url:i,headers:n,data:this.get("body")}).done(function(e,t,n){this.fire("displayResponse",n)}.bind(this)).fail(function(e){this.fire("displayResponse",e)}.bind(this))},displayResponse:function(n){this.set("sendButtonDisabled",!1),n.status>=200&&n.status<300?this.set("sendButtonClass","success"):this.set("sendButtonClass","danger"),r.setValue("HTTP/1.1 "+n.status+" "+n.statusText+"\n"+n.getAllResponseHeaders().trim(),-1);var i=n.getResponseHeader("content-type"),s="text";i&&(i.indexOf("json")!==-1?s="json":i.indexOf("html")!==-1?s="html":i.indexOf("javascript")!==-1?s="javascript":i.indexOf("xml")!==-1?s="xml":i.indexOf("css")!==-1&&(s="css")),c.getSession().setMode("ace/mode/"+s);if(typeof n.responseJSON!="undefined")e=JSON.stringify(n.responseJSON,null,2);else if(typeof n.responseXML!="undefined")e=u.xml((new XMLSerializer).serializeToString(n.responseXML),2);else if(i&&i.indexOf("javascript")!==-1)try{e=JSON.stringify(JSON.parse(n.responseText),null,2)}catch(o){e=n.responseText}else e=n.responseText;this.set("responseLength",e.length),e.length>3e3?(c.setValue(e.substring(0,3e3),-1),this.set("showMoreButton",!0)):this.fire("displayEntireResponse")},displayEntireResponse:function(){c.setValue(e,-1),this.set("showMoreButton",!1)}}),this.fire("scrollToPanel"),this.fire("setupTooltips")},toJSON:function(){var e={};for(var t in this.data)typeof t!="function"&&(e[t]=this.data[t]);return JSON.stringify(e)}});return l});