// Copyright (C) 2014 Erik Ringsmuth <erik.ringsmuth@gmail.com>

define(["require","config","Ractive","rv!./userTemplate","layouts/search/layout","router","components/xhrPanel/xhrPanel","components/apiSequence/apiSequence","jquery"],function(e){var t=e("config"),n=e("Ractive"),r=e("rv!./userTemplate"),i=e("layouts/search/layout"),s=e("router"),o=e("components/xhrPanel/xhrPanel"),u=e("components/apiSequence/apiSequence"),a=e("jquery"),f=n.extend({template:r,data:{from:0,size:10,filter:""},init:function(){this.set("userId",s.routeArguments().id),this.set("myProfile",this.get("userId")===t.session.userId),a(".bs-tooltip").tooltip();var e=new u({el:this.nodes["api-sequence"]});e.set("disableTutorial",!0),a.ajax("/users/"+this.get("userId")).done(function(e){this.set("emailMd5",e.emailMd5),this.set("displayName",e.displayName),a(".bs-tooltip").tooltip()}.bind(this)),this.observe({filter:function(){this.set("from",0),this.search()}}),this.on({teardown:function(){e.teardown()},openResult:function(t,n){new o({data:n})},setFrom:function(e,t){this.set("from",t),this.search()},editDisplayName:function(){this.set("editDisplayName",!0)},saveDisplayName:function(){this.set("editDisplayName",!1),a.ajax("/users/"+this.get("userId")+"/displayname",{type:"PUT",contentType:"application/json",data:JSON.stringify({displayName:this.get("displayName")})}).done(function(){t.session.displayName=this.get("displayName")}.bind(this)).fail(function(){this.set("displayName",t.session.displayName)}.bind(this))},cancelEditDisplayName:function(){this.set("displayName",t.session.displayName),this.set("editDisplayName",!1)}}),this.search()},search:function(){a.ajax("/xhr?from="+this.get("from")+"&owner="+this.get("userId")+"&q="+this.get("filter").trim()).done(function(e){this.set("xhrs",e),this.set("showPreviousButton",e.from>0),this.set("showNextButton",e.to<e.of-1)}.bind(this))}});return i.extend({components:{"content-placeholder":f}})});