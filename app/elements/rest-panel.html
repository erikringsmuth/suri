<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="rest-panel" attributes="name method url xhr send autosend">
  <template>
    <style>
      :host {
        display: block;
      }
      select {
        border: none;
        -webkit-appearance: none;
        -moz-appearance: none;
      }
      select::-ms-expand {
        display: none;
      }
      input {
        border: none;
      }
      input {
        width: 80%;
      }
      .uri {
        padding: 5px;
        background-color: #fdfdfd;
        border: #e1e1e8 1px solid;
        border-radius: 3px;
      }
      pre {
        background-color: #fdfdfd;
        border: #e1e1e8 1px solid;
        border-radius: 3px;
      }
    </style>
    <div class="panel panel-default">
      <div class="panel-heading">{{name}}</div>
      <div class="panel-body">
        <div class="uri">
          <select on-change="{{methodChanged}}">
            <option value="POST">POST</option>
            <option value="GET" selected>GET</option>
            <option value="PUT">PUT</option>
            <option value="PATCH">PATCH</option>
            <option value="DELETE">DELETE</option>
          </select>
          <input type="text" value="{{url}}" on-keypress="{{sendOnEnter}}" placeholder="http://">
          <span class="text-muted pull-right">HTTP/1.1</span>
        </div>
        <h4>request headers</h4>
<pre>
<code id="requestHeaders" contenteditable>Content-Type: application/json
Accept: application/json</code>
</pre>
        <h4>request body</h4>
<pre>
<code id="requestBody" contenteditable></code>
</pre>
        <button id="send" on-click="{{send}}" type="button" class="btn btn-{{sendButtonClass}}" disabled?="{{sendButtonDisabled}}">Send</button>
        <h4>response headers</h4>
<pre><code id="responseHeaders">{{responseHeaders}}</code></pre>
        <h4>response body</h4>
<pre><code id="responseBody"></code></pre>
      </div>
    </div>
  </template>
  <script>
    Polymer('rest-panel', {
      //applyAuthorStyles: true,
      //resetStyleInheritance: true,

      // element is fully prepared
      ready: function(){
        if (this.autosend !== false) {
          this.send();
        }
      },
      // instance of the element is created
      created: function() {
        this.xhr.onload = this.displayResponse.bind(this);
        this.xhr.onerror = this.displayResponse.bind(this);
      },
      // instance was inserted into the document
      enteredView: function() { },
      // instance was removed from the document
      leftView: function() { },
      // attribute added, removed or updated
      attributeChanged: function(attrName, oldVal, newVal) { },

      // properties
      name: 'XHR',
      method: 'GET',
      url: 'http://',
      xhr: new XMLHttpRequest,
      autosend: false,
      responseBody: '',
      sendButtonClass: 'default',
      sendButtonDisabled: false,

      // event handlers
      methodChanged: function methodChanged(event) {
        this.method = event.target.value;
      },

      sendOnEnter: function sendOnEnter(event) {
        if (event.keyCode === 13) {
          this.send();
        }
      },

      send: function send() {
        this.sendButtonClass = 'default';
        this.sendButtonDisabled = true;

        var pUrl = this.parsedUrl();
        this.xhr.open(this.method, pUrl.path, true);
        if (pUrl.host !== 'http://suri.io/' && pUrl.host !== 'http://www.suri.io/') {
          this.xhr.setRequestHeader('api-host', pUrl.host);
        }
        var headers = this.parsedRequestHeaders();
        for (var header in headers) {
          if (headers.hasOwnProperty(header)) {
            this.xhr.setRequestHeader(header, headers[header]);
          }
        }

        try {
          this.xhr.send(this.$.requestBody.innerText);
        } catch (exception) {
          this.$.responseBody.innerHTML = JSON.stringify(exception, null, 2);
        }
      },

      // helper methods
      parsedRequestHeaders: function parsedRequestHeaders() {
        var headers = {};
        var headerLines = this.$.requestHeaders.innerText.split('\n');
        for (var i = 0; i < headerLines.length; i++) {
          var headerParts = headerLines[i].split(':');
          headers[headerParts[0].trim()] = headerParts.splice(1).join(':').trim();
        }
        return headers;
      },

      parsedUrl: function parsedUrl() {
        var result = {
          path: '',
          host: ''
        };

        var url = this.url;
        if (url.substring(0, 4) !== 'http') {
          url = 'http://' + url;
        }
        result.host = 'http://' + url.split('/')[2] + '/';
        result.path = '/' + url.split('/').splice(3).join('/');

        return result;
      },

      displayResponse: function displayResponse() {
        // update send button
        this.sendButtonDisabled = false;
        if (this.xhr.status >= 200 && this.xhr.status < 400) {
          this.sendButtonClass = 'success';
        } else {
          this.sendButtonClass = 'danger';
        }

        // headers
        this.responseHeaders = this.xhr.getAllResponseHeaders();

        // body
        var contentType = this.xhr.getResponseHeader('content-type');
        var text = '';
        if (contentType) {
          if (contentType.indexOf('json') !== -1) {
            text = JSON.stringify(this.xhr.response, null, 2);
          } else if (contentType.indexOf('xml') !== -1) {
            text = this.xhr.responseXML;
          } else if (contentType.indexOf('html') !== -1) {
            text = this.xhr.response
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
          } else {
            text = this.xhr.response;
          }
        } else {
          text = this.xhr.response;
        }

        this.$.responseBody.innerHTML = text;
      }
    });
  </script>
</polymer-element>
