<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="rest-panel" attributes="name send">
  <template>
    <style>
      :host {
        display: block;
      }
      select, input {
        border: none;
      }
      input {
        width: 80%;
      }
      .uri {
        padding: 5px;
        background-color: #fdfdfd;
        border: #e1e1e8 1px solid;
        border-radius: 3px;
      }
      pre {
        background-color: #fdfdfd;
        border: #e1e1e8 1px solid;
        border-radius: 3px;
      }
    </style>
    <div class="panel panel-default">
      <div class="panel-heading">REST</div>
      <div class="panel-body">
        <div class="uri">
          <select on-change="{{methodChanged}}">
            <option value="POST">POST</option>
            <option value="GET" selected>GET</option>
            <option value="PUT">PUT</option>
            <option value="PATCH">PATCH</option>
            <option value="DELETE">DELETE</option>
          </select>
          <input type="text" value="{{url}}" on-keypress="{{sendOnEnter}}" placeholder="http://">
          <span class="text-muted pull-right">HTTP/1.1</span>
        </div>
        <h4>headers</h4>
<pre><code id="headers" contenteditable>Content-Type: application/json
Accept: application/json
</code></pre>
        <button id="send" on-click="{{send}}" type="button" class="btn btn-default">Send</button>
        <h4>response headers</h4>
<pre><code id="responseHeaders">
</code></pre>
        <h4>response body</h4>
<pre><code id="responseBody">
</code></pre>
      </div>
    </div>
  </template>
  <script>
    Polymer('rest-panel', {
      //applyAuthorStyles: true,
      //resetStyleInheritance: true,

      // element is fully prepared
      ready: function(){ },
      // instance of the element is created
      created: function() { },
      // instance was inserted into the document
      enteredView: function() { },
      // instance was removed from the document
      leftView: function() { },
      // attribute added, removed or updated
      attributeChanged: function(attrName, oldVal, newVal) { },

      name: '',

      method: 'GET',

      methodChanged: function methodChanged(event, detail, sender) {
        this.method = event.target.value;
      },

      url: 'http://',

      sendOnEnter: function sendOnEnter(event, detail, sender) {
        if (event.keyCode === 13) {
          this.send(event);
        }
      },

      send: function send(event, detail, sender) {
        this.$.send.disabled = true;
        this.$.send.classList.remove('btn-success');
        this.$.send.classList.remove('btn-danger');

        xhr = new XMLHttpRequest;
        xhr.open(this.method, this.url, true);

        xhr.onload = function onload() {
          if (xhr.status >= 200 && xhr.status < 400){
            this.$.send.disabled = false;
            this.$.send.classList.add('btn-success');
            this.displayResponse(xhr);
          } else {
            this.$.send.disabled = false;
            this.$.send.classList.add('btn-danger');
            this.displayResponse(xhr);
          }
        }.bind(this);

        xhr.onerror = function onerror() {
          this.$.send.disabled = false;
          this.$.send.classList.add('btn-danger');
          this.displayResponse(xhr);
        }.bind(this);

        xhr.send();
      },

      displayResponse: function displayResponse(xhr) {
        // headers
        this.$.responseHeaders.innerText = xhr.getAllResponseHeaders();

        // body
        var contentType = xhr.getResponseHeader('content-type');
        var text = '';
        if (contentType) {
          if (contentType.indexOf('json') !== -1) {
            text = JSON.stringify(xhr.response, null, 2);
          } else if (contentType.indexOf('xml') !== -1) {
            text = xhr.responseXML;
          } else if (contentType.indexOf('html') !== -1) {
            text = xhr.response
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
          } else {
            text = xhr.response;
          }
        } else {
          text = xhr.response;
        }

        this.$.responseBody.innerHTML = text;
      }
    });
  </script>
</polymer-element>