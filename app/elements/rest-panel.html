<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="rest-panel" attributes="name send">
  <template>
    <style>
      :host {
        display: block;
      }
      select, input {
        border: none;
      }
      input {
        width: 80%;
      }
      .uri {
        padding: 5px;
        background-color: #fdfdfd;
        border: #e1e1e8 1px solid;
        border-radius: 3px;
      }
      pre {
        background-color: #fdfdfd;
        border: #e1e1e8 1px solid;
        border-radius: 3px;
      }
    </style>
    <div class="panel panel-default">
      <div class="panel-heading">{{name}}</div>
      <div class="panel-body">
        <div class="uri">
          <select on-change="{{methodChanged}}">
            <option value="POST">POST</option>
            <option value="GET" selected>GET</option>
            <option value="PUT">PUT</option>
            <option value="PATCH">PATCH</option>
            <option value="DELETE">DELETE</option>
          </select>
          <input type="text" value="{{url}}" on-keypress="{{sendOnEnter}}" placeholder="http://">
          <span class="text-muted pull-right">HTTP/1.1</span>
        </div>
        <h4>request headers</h4>
<pre>
<code id="headers" contenteditable>{{requestHeaders}}</code>
</pre>
        <h4>request body</h4>
<pre>
<code id="headers" contenteditable>{{requestBody}}</code>
</pre>
        <button id="send" on-click="{{send}}" type="button" class="btn btn-{{sendButtonClass}}" disabled?="{{sendButtonDisabled}}">Send</button>
        <h4>response headers</h4>
<pre><code id="responseHeaders">{{responseHeaders}}</code></pre>
        <h4>response body</h4>
<pre><code id="responseBody"></code></pre>
      </div>
    </div>
  </template>
  <script>
    Polymer('rest-panel', {
      //applyAuthorStyles: true,
      //resetStyleInheritance: true,

      // element is fully prepared
      ready: function(){
        this.xhr.onload = this.displayResponse.bind(this);
        this.xhr.onerror = this.displayResponse.bind(this);
      },
      // instance of the element is created
      created: function() { },
      // instance was inserted into the document
      enteredView: function() { },
      // instance was removed from the document
      leftView: function() { },
      // attribute added, removed or updated
      attributeChanged: function(attrName, oldVal, newVal) { },

      // properties
      name: 'XHR',
      method: 'GET',
      url: 'http://',
      xhr: new XMLHttpRequest,
      requestHeaders: 'Content-Type: application/json\nAccept: application/json',
      responseHeaders: '',
      responseBody: '',
      sendButtonClass: 'default',
      sendButtonDisabled: false,

      // event handlers
      methodChanged: function methodChanged(event, detail, sender) {
        this.method = event.target.value;
      },

      sendOnEnter: function sendOnEnter(event, detail, sender) {
        if (event.keyCode === 13) {
          this.send(event);
        }
      },

      send: function send(event, detail, sender) {
        this.sendButtonClass = 'default';
        this.sendButtonDisabled = true;

        this.xhr.open(this.method, this.url, true);
        try {
          this.xhr.send();
        } catch (exception) {
          this.$.responseBody.innerHTML = JSON.stringify(exception, null, 2);
        }
      },

      // helper methods
      displayResponse: function displayResponse() {
        // update send button
        this.sendButtonDisabled = false;
        if (this.xhr.status >= 200 && this.xhr.status < 400) {
          this.sendButtonClass = 'success';
        } else {
          this.sendButtonClass = 'danger';
        }

        // headers
        this.responseHeaders = this.xhr.getAllResponseHeaders();

        // body
        var contentType = this.xhr.getResponseHeader('content-type');
        var text = '';
        if (contentType) {
          if (contentType.indexOf('json') !== -1) {
            text = JSON.stringify(this.xhr.response, null, 2);
          } else if (contentType.indexOf('xml') !== -1) {
            text = this.xhr.responseXML;
          } else if (contentType.indexOf('html') !== -1) {
            text = this.xhr.response
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
          } else {
            text = this.xhr.response;
          }
        } else {
          text = this.xhr.response;
        }

        this.$.responseBody.innerHTML = text;
      }
    });
  </script>
</polymer-element>
